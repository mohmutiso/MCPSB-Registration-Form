<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>MCPSB Attendance Register</title>

<link rel="stylesheet" href="/static/styles.css">

<style>

/* SUCCESS OVERLAY */

.success-overlay{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.6);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:9999;
}

.success-box{
    background:white;
    padding:40px;
    border-radius:12px;
    text-align:center;
    max-width:420px;
    animation:scaleIn .3s ease;
}

.checkmark{
    font-size:60px;
    color:#2ecc71;
}

.success-box button{
    margin-top:20px;
    padding:10px 20px;
    border:none;
    background:#0052cc;
    color:white;
    border-radius:6px;
    cursor:pointer;
}

@keyframes scaleIn{
from{transform:scale(.8);opacity:0;}
to{transform:scale(1);opacity:1;}
}

</style>

</head>

<body>

<!-- SUCCESS CARD -->

<div id="successCard" class="success-overlay">

<div class="success-box">

<div class="checkmark">✓</div>

<h2>Attendance Registered Successfully</h2>

<p>
Thank you, you have successfully registered attendance for MCPSB Induction Meeting held at Mombasa Beach Hotel.
<strong>MCPSB Meeting</strong>.
</p>

<button onclick="location.reload()">Register Another Person</button>

</div>

</div>

<!-- HEADER -->

<div class="header">

<img src="/static/county_logo.png" class="logo">

<h1>MAKUENI COUNTY PUBLIC SERVICE BOARD</h1>

<p>
P.O BOX 49 – 90300 MAKUENI Tel:0202026751<br>
EMAIL: cpsb@makueni.go.ke<br>
Web: www.makuenipsb.go.ke
</p>

</div>

<!-- FORM -->

<form id="attendanceForm">

<h2>MCPSB Attendance Register</h2>

<h3>SECTION A: PERSONAL PARTICULARS</h3>

<label>Title</label>
<select name="title" id="titleSelect" onchange="toggleCustomTitle()" required>
<option value="">Select</option>
<option>Mr.</option>
<option>Mrs.</option>
<option>Ms.</option>
<option>Dr.</option>
<option>Prof.</option>
<option>Eng.</option>
<option>CPA</option>
<option>FCPA</option>
<option value="Other">Other (Specify)</option>
</select>

<input type="text" id="customTitle" name="custom_title" placeholder="Enter custom title" style="display:none;">

<label>First Name</label>
<input type="text" name="first_name" required>

<label>Surname</label>
<input type="text" name="surname" required>

<label>Other Name(s)</label>
<input type="text" name="other_names">

<label>ID / Payroll Number</label>
<input type="text" name="id_number" required>

<label>Designation</label>
<input type="text" name="designation" required>

<label>Department/Organization</label>
<input type="text" name="organization" required>

<h3>SECTION B: DEMOGRAPHIC INFORMATION</h3>

<label>Gender</label>
<div class="radio-group">
<label><input type="radio" name="gender" value="Male" required> Male</label>
<label><input type="radio" name="gender" value="Female"> Female</label>
<label><input type="radio" name="gender" value="Prefer not to say"> Prefer not to say</label>
</div>

<label>Person With Disability (PWD)</label>
<div class="radio-group">
<label><input type="radio" name="pwd" value="Yes" onclick="togglePWD(true)"> Yes</label>
<label><input type="radio" name="pwd" value="No" onclick="togglePWD(false)"> No</label>
</div>


<div id="pwdDetails" class="checkbox-group" style="display:none;">
<input type="checkbox" name="disability_category" value="Physical"> Physical
<input type="checkbox" name="disability_category" value="Visual"> Visual
<input type="checkbox" name="disability_category" value="Hearing"> Hearing
<input type="checkbox" name="disability_category" value="Intellectual"> Intellectual
</div>

<h3>SECTION C</h3>

<canvas id="signatureCanvas"></canvas>

<button type="button" onclick="clearSignature()">Clear Signature</button>

<input type="hidden" name="signature" id="signatureInput">

<label>Date</label>
<input type="text" name="date" id="dateInput" readonly>

<label>Time</label>
<input type="text" name="time" id="timeInput" readonly>

<label>
<input type="checkbox" name="declaration" required>
I hereby declare that the information provided is true.
</label>

<button type="submit">Submit</button>

</form>

<script>

/* UI */

function toggleCustomTitle(){
const select=document.getElementById("titleSelect");
const custom=document.getElementById("customTitle");

if(select.value==="Other"){
custom.style.display="block";
custom.required=true;
}else{
custom.style.display="none";
custom.required=false;
}
}

function togglePWD(show){
document.getElementById("pwdDetails").style.display=show?"flex":"none";
}

const now=new Date();
dateInput.value=now.toLocaleDateString();
timeInput.value=now.toLocaleTimeString();

/* SIGNATURE */

/* ===============================
   ULTRA SMOOTH PROFESSIONAL SIGNATURE
================================ */

const canvas = document.getElementById("signatureCanvas");
const ctx = canvas.getContext("2d");

let drawing = false;
let points = [];

/* ---- HIGH RESOLUTION CANVAS ---- */

function resizeCanvas() {

    const ratio = window.devicePixelRatio || 1;

    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;

    ctx.scale(ratio, ratio);

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#000";
}

resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ---- GET POSITION (MOUSE + TOUCH) ---- */

function getPos(e) {

    const rect = canvas.getBoundingClientRect();

    if (e.touches) {
        return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
        };
    }

    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

/* ---- START DRAW ---- */

function startDraw(e) {

    drawing = true;
    points = [];

    const pos = getPos(e);
    points.push(pos);

    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
}

/* ---- SMOOTH CURVE DRAW ---- */

function draw(e) {

    if (!drawing) return;

    e.preventDefault(); // critical for mobile

    const pos = getPos(e);
    points.push(pos);

    if (points.length < 3) return;

    const p1 = points[points.length - 3];
    const p2 = points[points.length - 2];
    const p3 = points[points.length - 1];

    const midPointX = (p2.x + p3.x) / 2;
    const midPointY = (p2.y + p3.y) / 2;

    ctx.quadraticCurveTo(p2.x, p2.y, midPointX, midPointY);
    ctx.stroke();
}

/* ---- STOP DRAW ---- */

function stopDraw() {

    drawing = false;
    points = [];
}

/* ---- EVENTS ---- */

// Mouse
canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("mouseup", stopDraw);
canvas.addEventListener("mouseleave", stopDraw);

// Touch
canvas.addEventListener("touchstart", startDraw);
canvas.addEventListener("touchmove", draw);
canvas.addEventListener("touchend", stopDraw);

/* ---- CLEAR SIGNATURE ---- */

function clearSignature(){

    ctx.clearRect(0,0,canvas.width,canvas.height);
}

/* ---- SAVE SIGNATURE BEFORE SUBMIT ---- */

document.getElementById("attendanceForm")
.addEventListener("submit", function(){

    document.getElementById("signatureInput").value =
        canvas.toDataURL("image/png");
});



/* SUBMIT */

document.getElementById("attendanceForm").addEventListener("submit", async function(e){

e.preventDefault();

signatureInput.value=canvas.toDataURL();

const formData=new FormData(this);

const response=await fetch("/submit-form/",{
method:"POST",
body:formData
});

const result=await response.json();

if(result.status==="success"){

document.getElementById("successCard").style.display="flex";

}

else if(result.status==="duplicate"){

alert("This ID already registered.");

}else{

alert("Error submitting form.");

}

});

</script>

</body>
</html>
